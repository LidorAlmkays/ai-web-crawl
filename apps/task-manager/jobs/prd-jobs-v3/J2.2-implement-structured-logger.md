# Job 2.2: Implement Enhanced Structured Logger

## Objective

Implement an enhanced structured logger that wraps Winston with color circles and preserves the structured format for future OTEL integration.

## Problem Analysis

Need a structured logger that:

- Wraps Winston for production-ready logging
- Includes color circles for better readability
- Preserves structured format for OTEL compatibility
- Supports file and console transports
- Maintains backward compatibility

## Solution

### Format Specification

**Format**: `*[level:severity,service:servicename,timestamp:datetime]:message*`

**Color Scheme** (same as simple logger):

- ðŸ”´ **ERROR**: Red color
- ðŸŸ¡ **INFO**: Yellow color
- ðŸ”µ **DEBUG**: Blue color
- ðŸŸ¢ **SUCCESS**: Green color
- âšª **WARN**: White color

### Implementation

**File**: `src/common/utils/structured-logger.ts`

```typescript
import { Logger } from 'winston';
import { createLogger, format, transports } from 'winston';
import chalk from 'chalk';

export interface StructuredLogger {
  error(message: string, meta?: any): void;
  info(message: string, meta?: any): void;
  debug(message: string, meta?: any): void;
  success(message: string, meta?: any): void;
  warn(message: string, meta?: any): void;
}

export class StructuredLoggerImpl implements StructuredLogger {
  private logger: Logger;

  constructor() {
    const { combine, timestamp, printf } = format;

    const taskManagerFormat = printf((info) => {
      const emoji = this.getEmoji(info.level);
      const color = this.getColor(info.level);
      const metaString = Object.keys(info).length > 3 ? ` ${JSON.stringify(info)}` : '';
      const baseMessage = `${emoji}[level:${info.level.toUpperCase()},service:Task Manager,timestamp:${info.timestamp}]:${info.message}${metaString}`;
      return color(baseMessage);
    });

    this.logger = createLogger({
      level: process.env.LOG_LEVEL || 'debug',
      format: combine(timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }), taskManagerFormat),
      transports: [
        new transports.Console({
          format: combine(timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }), taskManagerFormat),
        }),
        new transports.File({
          filename: 'logs/task-manager-error.log',
          level: 'error',
          format: combine(timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }), taskManagerFormat),
        }),
        new transports.File({
          filename: 'logs/task-manager-combined.log',
          format: combine(timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }), taskManagerFormat),
        }),
      ],
    });
  }

  private getEmoji(level: string): string {
    switch (level.toLowerCase()) {
      case 'error':
        return 'ðŸ”´';
      case 'info':
        return 'ðŸŸ¡';
      case 'debug':
        return 'ðŸ”µ';
      case 'success':
        return 'ðŸŸ¢';
      case 'warn':
        return 'âšª';
      default:
        return 'âšª';
    }
  }

  private getColor(level: string): (text: string) => string {
    switch (level.toLowerCase()) {
      case 'error':
        return chalk.red;
      case 'info':
        return chalk.yellow;
      case 'debug':
        return chalk.blue;
      case 'success':
        return chalk.green;
      case 'warn':
        return chalk.white;
      default:
        return chalk.white;
    }
  }

  error(message: string, meta?: any): void {
    this.logger.error(message, meta);
  }

  info(message: string, meta?: any): void {
    this.logger.info(message, meta);
  }

  debug(message: string, meta?: any): void {
    this.logger.debug(message, meta);
  }

  success(message: string, meta?: any): void {
    this.logger.info(message, meta); // Winston doesn't have success level
  }

  warn(message: string, meta?: any): void {
    this.logger.warn(message, meta);
  }
}
```

## Implementation Steps

### Step 1: Install Dependencies

```bash
npm install winston chalk
npm install --save-dev @types/winston @types/chalk
```

### Step 2: Create Structured Logger File

1. Create `src/common/utils/structured-logger.ts`
2. Implement `StructuredLogger` interface
3. Implement `StructuredLoggerImpl` class
4. Configure Winston with custom format
5. Add color and emoji helper methods

### Step 3: Configure Winston Transports

1. Console transport with color formatting
2. Error file transport
3. Combined log file transport
4. Custom timestamp format

### Step 4: Testing

1. Create unit tests for all log levels
2. Test file logging functionality
3. Test color output
4. Test structured format
5. Test metadata handling

## Success Criteria

- [ ] Structured logger outputs formatted messages with color circles
- [ ] Winston integration works correctly
- [ ] File logging to error and combined logs
- [ ] Console output with colors
- [ ] Structured format preserved for OTEL compatibility
- [ ] All log levels display correct emojis and colors
- [ ] Metadata is properly handled
- [ ] Unit tests pass

## Example Output

```
ðŸ”´[level:ERROR,service:Task Manager,timestamp:2025-08-10 10:17:12]:Failed to create web crawl task
ðŸŸ¡[level:INFO,service:Task Manager,timestamp:2025-08-10 10:17:12]:Processing new task message
ðŸ”µ[level:DEBUG,service:Task Manager,timestamp:2025-08-10 10:17:12]:Executing create_web_crawl_task procedure
ðŸŸ¢[level:INFO,service:Task Manager,timestamp:2025-08-10 10:17:12]:Task created successfully
âšª[level:WARN,service:Task Manager,timestamp:2025-08-10 10:17:12]:Task processing warning
```

## Testing

### Unit Tests

```typescript
describe('StructuredLoggerImpl', () => {
  let logger: StructuredLoggerImpl;

  beforeEach(() => {
    logger = new StructuredLoggerImpl();
  });

  it('should format structured messages correctly', () => {
    const consoleSpy = jest.spyOn(console, 'log').mockImplementation();

    logger.info('Test structured message');

    expect(consoleSpy).toHaveBeenCalledWith(expect.stringMatching(/ðŸŸ¡\[level:INFO,service:Task Manager,timestamp:.*\]:Test structured message/));

    consoleSpy.mockRestore();
  });

  it('should handle success level as info', () => {
    const consoleSpy = jest.spyOn(console, 'log').mockImplementation();

    logger.success('Test success message');

    expect(consoleSpy).toHaveBeenCalledWith(expect.stringMatching(/ðŸŸ¢\[level:INFO,service:Task Manager,timestamp:.*\]:Test success message/));

    consoleSpy.mockRestore();
  });

  it('should write to log files', () => {
    // Test file logging functionality
    logger.error('Test error for file logging');

    // Verify error log file exists and contains the message
    // This would require file system testing
  });
});
```

## Dependencies

- `winston` package for structured logging
- `chalk` package for color output
- `@types/winston` and `@types/chalk` for TypeScript support

## File Structure

```
logs/
â”œâ”€â”€ task-manager-error.log    # Error level logs only
â””â”€â”€ task-manager-combined.log # All log levels
```

## Risks and Mitigation

### Risks

1. **Winston Configuration**: Complex Winston setup might be error-prone
2. **File Permissions**: Log files might not be writable
3. **Performance**: Winston overhead might impact performance
4. **Format Compatibility**: Structured format might not be OTEL compatible

### Mitigation

1. **Configuration Testing**: Thorough testing of Winston configuration
2. **File Permissions**: Ensure proper file permissions and error handling
3. **Performance Monitoring**: Monitor Winston performance impact
4. **Format Validation**: Validate structured format against OTEL standards
