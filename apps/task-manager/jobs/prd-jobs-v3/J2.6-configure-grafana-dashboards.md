# Job 2.6: Configure Grafana Dashboards and Datasources

## Objective

Configure Grafana with automatic datasource provisioning and sample dashboards for the observability stack.

## Problem Analysis

Need to create:

- Grafana datasource configurations for Prometheus, Loki, and Jaeger
- Dashboard provisioning configuration
- Sample dashboard for task manager metrics
- Automatic setup without manual configuration

## Solution

### 1. Grafana Datasources Configuration

**File**: `deployment/observability/grafana/provisioning/datasources/datasources.yml`

```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true

  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100

  - name: Jaeger
    type: jaeger
    access: proxy
    url: http://jaeger:16686
```

### 2. Dashboard Provisioning Configuration

**File**: `deployment/observability/grafana/provisioning/dashboards/dashboards.yml`

```yaml
apiVersion: 1

providers:
  - name: 'default'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /etc/grafana/provisioning/dashboards
```

### 3. Sample Task Manager Dashboard

**File**: `deployment/observability/grafana/provisioning/dashboards/task-manager-overview.json`

```json
{
  "dashboard": {
    "id": null,
    "title": "Task Manager Overview",
    "tags": ["task-manager", "observability"],
    "style": "dark",
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "Task Status Overview",
        "type": "stat",
        "targets": [
          {
            "expr": "task_manager_tasks_total",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "palette-classic"
            },
            "custom": {
              "displayMode": "list"
            }
          }
        }
      },
      {
        "id": 2,
        "title": "Task Processing Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(task_manager_tasks_processed_total[5m])",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {
              "mode": "palette-classic"
            }
          }
        }
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "5s"
  }
}
```

## Implementation Steps

### Step 1: Create Grafana Directory Structure

```bash
mkdir -p deployment/observability/grafana/provisioning/datasources
mkdir -p deployment/observability/grafana/provisioning/dashboards
```

### Step 2: Create Datasource Configuration

1. Create `deployment/observability/grafana/provisioning/datasources/datasources.yml`
2. Configure Prometheus datasource
3. Configure Loki datasource
4. Configure Jaeger datasource

### Step 3: Create Dashboard Configuration

1. Create `deployment/observability/grafana/provisioning/dashboards/dashboards.yml`
2. Configure dashboard provider
3. Set up automatic dashboard loading

### Step 4: Create Sample Dashboard

1. Create `deployment/observability/grafana/provisioning/dashboards/task-manager-overview.json`
2. Design dashboard panels
3. Configure metrics queries
4. Set up time range and refresh

### Step 5: Test Configuration

1. Start Grafana with new configuration
2. Verify datasources are automatically configured
3. Verify dashboard is automatically loaded
4. Test dashboard functionality

## Success Criteria

- [ ] Grafana datasources are automatically configured
- [ ] Sample dashboard is automatically loaded
- [ ] Prometheus metrics are accessible
- [ ] Loki logs are accessible
- [ ] Jaeger traces are accessible
- [ ] Dashboard panels display data correctly
- [ ] No manual configuration required

## Testing

### Grafana Configuration Tests

```bash
# Start the observability stack
cd deployment
docker-compose -f docker-compose.observability.yml up -d

# Wait for Grafana to start
sleep 30

# Test Grafana health
curl http://localhost:3000/api/health

# Test datasource connectivity
curl -u admin:admin http://localhost:3000/api/datasources

# Test dashboard loading
curl -u admin:admin http://localhost:3000/api/dashboards
```

### Dashboard Functionality Tests

1. **Prometheus Metrics**: Verify task manager metrics are displayed
2. **Loki Logs**: Verify logs are searchable and displayed
3. **Jaeger Traces**: Verify traces are viewable
4. **Dashboard Panels**: Verify all panels show data
5. **Time Range**: Verify time range controls work
6. **Refresh**: Verify auto-refresh works

## Access Points

- **Grafana**: http://localhost:3000 (admin/admin)
- **Task Manager Dashboard**: http://localhost:3000/d/task-manager-overview

## Example Dashboard Queries

### Prometheus Metrics

```promql
# Total tasks
task_manager_tasks_total

# Task processing rate
rate(task_manager_tasks_processed_total[5m])

# Error rate
rate(task_manager_errors_total[5m])

# Response time
histogram_quantile(0.95, rate(task_manager_request_duration_seconds_bucket[5m]))
```

### Loki Log Queries

```logql
# All task manager logs
{job="task-manager"}

# Error logs only
{job="task-manager"} |= "error"

# Logs by level
{job="task-manager"} | json | level="error"
```

## Dependencies

- Observability stack running (J2.5)
- Prometheus with task manager metrics
- Loki with task manager logs
- Jaeger with task manager traces

## Risks and Mitigation

### Risks

1. **Configuration Errors**: Incorrect datasource configuration
2. **Dashboard Issues**: Dashboard might not load correctly
3. **Data Availability**: Metrics/logs might not be available
4. **Permission Issues**: Grafana might not have proper permissions

### Mitigation

1. **Configuration Validation**: Validate all configuration files
2. **Dashboard Testing**: Test dashboard with sample data
3. **Data Verification**: Ensure metrics and logs are being sent
4. **Permission Setup**: Ensure proper file permissions for Grafana
