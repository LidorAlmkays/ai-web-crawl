# Job 2.3: Implement OTel Logger

## Objective

Implement a dedicated OpenTelemetry logger that sends structured logs directly to an OTEL collector with trace context and span correlation.

## Problem Analysis

Need an OTel logger that:

- Integrates with OpenTelemetry SDK
- Sends logs as spans with attributes
- Supports trace context injection
- Provides structured metadata
- Connects to OTEL collector

## Solution

### Implementation

**File**: `src/common/utils/otel-logger.ts`

```typescript
import { trace, context, SpanStatusCode } from '@opentelemetry/api';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';
import { Resource } from '@opentelemetry/resources';
import { NodeSDK } from '@opentelemetry/sdk-node';
import { SimpleSpanProcessor } from '@opentelemetry/sdk-trace-base';
import { SemanticResourceAttributes } from '@opentelemetry/semantic-conventions';

export interface OtelLogger {
  error(message: string, meta?: any): void;
  info(message: string, meta?: any): void;
  debug(message: string, meta?: any): void;
  success(message: string, meta?: any): void;
  warn(message: string, meta?: any): void;
  setTraceContext(traceId: string, spanId: string): void;
}

export class OtelLoggerImpl implements OtelLogger {
  private tracer: any;
  private currentTraceId?: string;
  private currentSpanId?: string;

  constructor() {
    // Initialize OTEL SDK
    const sdk = new NodeSDK({
      resource: new Resource({
        [SemanticResourceAttributes.SERVICE_NAME]: 'task-manager',
        [SemanticResourceAttributes.SERVICE_VERSION]: '1.0.0',
      }),
      spanProcessor: new SimpleSpanProcessor(
        new OTLPTraceExporter({
          url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || 'http://localhost:4318/v1/traces',
        })
      ),
    });

    sdk.start();
    this.tracer = trace.getTracer('task-manager');
  }

  private createLogRecord(level: string, message: string, meta?: any) {
    const span = this.tracer.startSpan(`log.${level}`);

    try {
      span.setStatus({ code: SpanStatusCode.OK });
      span.setAttributes({
        'log.level': level,
        'log.message': message,
        'log.timestamp': new Date().toISOString(),
        'service.name': 'task-manager',
        'service.version': '1.0.0',
      });

      if (meta) {
        span.setAttributes({
          'log.metadata': JSON.stringify(meta),
        });
      }

      if (this.currentTraceId && this.currentSpanId) {
        span.setAttributes({
          'trace.id': this.currentTraceId,
          'span.id': this.currentSpanId,
        });
      }

      // Add log record to span
      span.addEvent('log', {
        'log.level': level,
        'log.message': message,
        'log.metadata': meta ? JSON.stringify(meta) : undefined,
      });
    } finally {
      span.end();
    }
  }

  setTraceContext(traceId: string, spanId: string): void {
    this.currentTraceId = traceId;
    this.currentSpanId = spanId;
  }

  error(message: string, meta?: any): void {
    this.createLogRecord('error', message, meta);
  }

  info(message: string, meta?: any): void {
    this.createLogRecord('info', message, meta);
  }

  debug(message: string, meta?: any): void {
    this.createLogRecord('debug', message, meta);
  }

  success(message: string, meta?: any): void {
    this.createLogRecord('success', message, meta);
  }

  warn(message: string, meta?: any): void {
    this.createLogRecord('warn', message, meta);
  }
}
```

## Implementation Steps

### Step 1: Install Dependencies

```bash
npm install @opentelemetry/api @opentelemetry/sdk-node @opentelemetry/exporter-trace-otlp-http @opentelemetry/resources @opentelemetry/semantic-conventions
```

### Step 2: Create OTel Logger File

1. Create `src/common/utils/otel-logger.ts`
2. Implement `OtelLogger` interface
3. Implement `OtelLoggerImpl` class
4. Configure OTEL SDK with OTLP exporter
5. Add trace context management

### Step 3: Configure Environment Variables

```bash
# OTEL Configuration
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
OTEL_SERVICE_NAME=task-manager
OTEL_SERVICE_VERSION=1.0.0
```

### Step 4: Testing

1. Create unit tests for all log levels
2. Test trace context injection
3. Test span creation
4. Test OTEL collector connectivity
5. Test metadata handling

## Success Criteria

- [ ] OTel logger sends structured logs to collector
- [ ] Trace context can be set and used
- [ ] Spans are created with proper attributes
- [ ] Log levels are properly mapped
- [ ] Metadata is included in spans
- [ ] OTEL SDK initializes correctly
- [ ] Unit tests pass
- [ ] Integration with OTEL collector works

## Example Output

```
# Logs sent to OTEL collector with trace context and structured metadata
# Each log creates a span with attributes:
# - log.level: 'error'|'info'|'debug'|'success'|'warn'
# - log.message: The actual log message
# - log.timestamp: ISO timestamp
# - service.name: 'task-manager'
# - service.version: '1.0.0'
# - log.metadata: JSON string of metadata (if provided)
# - trace.id: Current trace ID (if set)
# - span.id: Current span ID (if set)
```

## Testing

### Unit Tests

```typescript
describe('OtelLoggerImpl', () => {
  let logger: OtelLoggerImpl;

  beforeEach(() => {
    process.env.OTEL_EXPORTER_OTLP_ENDPOINT = 'http://localhost:4318/v1/traces';
    logger = new OtelLoggerImpl();
  });

  it('should set trace context', () => {
    expect(() => {
      logger.setTraceContext('trace-123', 'span-456');
    }).not.toThrow();
  });

  it('should log messages to OTEL', () => {
    expect(() => {
      logger.info('Test OTEL message');
    }).not.toThrow();
  });

  it('should handle metadata', () => {
    expect(() => {
      logger.error('Test error', { userId: '123', error: 'test' });
    }).not.toThrow();
  });
});
```

## Dependencies

- `@opentelemetry/api` - OTEL API
- `@opentelemetry/sdk-node` - Node.js SDK
- `@opentelemetry/exporter-trace-otlp-http` - OTLP HTTP exporter
- `@opentelemetry/resources` - Resource management
- `@opentelemetry/semantic-conventions` - Semantic conventions

## Environment Variables

```bash
# OTEL Configuration
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
OTEL_SERVICE_NAME=task-manager
OTEL_SERVICE_VERSION=1.0.0
```

## Risks and Mitigation

### Risks

1. **OTEL Complexity**: OTEL SDK setup might be complex
2. **Network Issues**: OTEL collector connectivity might fail
3. **Performance Impact**: OTEL overhead might slow down application
4. **Configuration Errors**: Incorrect OTEL configuration

### Mitigation

1. **Thorough Testing**: Test OTEL SDK initialization and configuration
2. **Error Handling**: Handle network failures gracefully
3. **Performance Monitoring**: Monitor OTEL performance impact
4. **Configuration Validation**: Validate OTEL configuration at startup
