# Job 4.2: Logging System Integration Testing

## Objective

Comprehensive integration testing of the logging system to ensure all three logger types function correctly and integrate properly with the application.

## Problem Analysis

After implementing J2 (Enhanced Logging System), we need to verify that:

- All three logger types (simple, structured, OTel) work correctly
- Logger factory switching works properly
- Environment variable configuration works
- Log formats are correct
- File logging works for structured logger
- OTel integration works

## Solution

### Implementation

**File**: `src/common/utils/__tests__/logging-integration.spec.ts`

```typescript
import { LoggerFactory, ILogger } from '../logger-factory';
import { TaskStatus } from '../../enums/task-status.enum';

describe('Logging System Integration Tests', () => {
  let logger: ILogger;

  beforeEach(() => {
    // Reset logger factory
    LoggerFactory.resetLogger();
  });

  describe('Simple Logger', () => {
    beforeEach(() => {
      process.env.LOG_FORMAT = 'simple';
      logger = LoggerFactory.getLogger();
    });

    it('should log messages with correct format', () => {
      const consoleSpy = jest.spyOn(console, 'log').mockImplementation();

      logger.info('Test info message');
      logger.error('Test error message');
      logger.debug('Test debug message');
      logger.success('Test success message');
      logger.warn('Test warn message');

      expect(consoleSpy).toHaveBeenCalledTimes(5);

      // Verify format: emoji[timestamp]:message
      const calls = consoleSpy.mock.calls;
      expect(calls[0][0]).toMatch(/游리\[.*\]:Test info message/);
      expect(calls[1][0]).toMatch(/游댮\[.*\]:Test error message/);
      expect(calls[2][0]).toMatch(/游댯\[.*\]:Test debug message/);
      expect(calls[3][0]).toMatch(/游릭\[.*\]:Test success message/);
      expect(calls[4][0]).toMatch(/丘뾮[.*\]:Test warn message/);

      consoleSpy.mockRestore();
    });

    it('should include metadata when provided', () => {
      const consoleSpy = jest.spyOn(console, 'log').mockImplementation();

      logger.info('Test info message', { userId: '123', action: 'create' });

      expect(consoleSpy).toHaveBeenCalledWith(expect.stringMatching(/游리\[.*\]:Test info message {"userId":"123","action":"create"}/));

      consoleSpy.mockRestore();
    });
  });

  describe('Structured Logger', () => {
    beforeEach(() => {
      process.env.LOG_FORMAT = 'structured';
      logger = LoggerFactory.getLogger();
    });

    it('should log messages with structured format', () => {
      const consoleSpy = jest.spyOn(console, 'log').mockImplementation();

      logger.info('Test structured message');

      expect(consoleSpy).toHaveBeenCalled();

      // Verify format: emoji[level:LEVEL,service:Task Manager,timestamp:datetime]:message
      const call = consoleSpy.mock.calls[0][0];
      expect(call).toMatch(/游리\[level:INFO,service:Task Manager,timestamp:.*\]:Test structured message/);

      consoleSpy.mockRestore();
    });

    it('should write to log files', () => {
      // Test file logging functionality
      logger.error('Test error for file logging');

      // Verify error log file exists and contains the message
      // This would require file system testing
    });

    it('should handle all log levels', () => {
      const consoleSpy = jest.spyOn(console, 'log').mockImplementation();

      logger.error('Test error');
      logger.info('Test info');
      logger.debug('Test debug');
      logger.success('Test success');
      logger.warn('Test warn');

      expect(consoleSpy).toHaveBeenCalledTimes(5);

      consoleSpy.mockRestore();
    });
  });

  describe('OTel Logger', () => {
    beforeEach(() => {
      process.env.LOG_FORMAT = 'otel';
      process.env.OTEL_EXPORTER_OTLP_ENDPOINT = 'http://localhost:4318/v1/traces';
      logger = LoggerFactory.getLogger();
    });

    it('should set trace context', () => {
      if (logger.setTraceContext) {
        expect(() => {
          logger.setTraceContext('trace-123', 'span-456');
        }).not.toThrow();
      }
    });

    it('should log messages to OTEL', () => {
      // Test OTEL logging functionality
      // This would require OTEL collector testing
      expect(() => {
        logger.info('Test OTEL message');
      }).not.toThrow();
    });

    it('should handle metadata in OTEL', () => {
      expect(() => {
        logger.error('Test error', { userId: '123', error: 'test error' });
      }).not.toThrow();
    });
  });

  describe('Logger Factory', () => {
    it('should create simple logger by default', () => {
      delete process.env.LOG_FORMAT;
      const logger = LoggerFactory.getLogger();
      expect(logger).toBeDefined();
    });

    it('should switch loggers based on environment variable', () => {
      process.env.LOG_FORMAT = 'structured';
      const structuredLogger = LoggerFactory.getLogger();

      process.env.LOG_FORMAT = 'otel';
      LoggerFactory.resetLogger();
      const otelLogger = LoggerFactory.getLogger();

      expect(structuredLogger).not.toBe(otelLogger);
    });

    it('should maintain singleton pattern', () => {
      const logger1 = LoggerFactory.getLogger();
      const logger2 = LoggerFactory.getLogger();
      expect(logger1).toBe(logger2);
    });
  });

  describe('Application Integration', () => {
    it('should work with task manager service', () => {
      // Test logging integration with actual application code
      const consoleSpy = jest.spyOn(console, 'log').mockImplementation();

      // Simulate task manager operations
      logger.info('Starting task creation');
      logger.success('Task created successfully', { taskId: 'test-123' });
      logger.error('Task processing failed', { taskId: 'test-123', error: 'test error' });

      expect(consoleSpy).toHaveBeenCalledTimes(3);

      consoleSpy.mockRestore();
    });
  });
});
```

## Implementation Steps

### Step 1: Setup Test Environment

1. Configure test logging environment
2. Setup file system testing for structured logger
3. Setup OTEL collector for OTel logger testing

### Step 2: Create Integration Tests

1. Test all three logger types
2. Test logger factory switching
3. Test environment variable configuration
4. Test log formats and colors

### Step 3: Test File Logging

1. Test structured logger file output
2. Test error log file
3. Test combined log file
4. Test file permissions and rotation

### Step 4: Test OTel Integration

1. Test OTEL collector connectivity
2. Test trace context injection
3. Test span creation
4. Test metadata handling

## Success Criteria

- [ ] All three logger types function correctly
- [ ] Logger factory switching works properly
- [ ] Environment variable configuration works
- [ ] Log formats are correct with colors and emojis
- [ ] File logging works for structured logger
- [ ] OTel integration works with collector
- [ ] Application integration works correctly
- [ ] All tests pass

## Testing Strategy

### Unit Tests

- Test individual logger implementations
- Test logger factory
- Test format validation

### Integration Tests

- Test with application code
- Test file system integration
- Test OTEL collector integration

### Format Tests

- Test all log formats
- Test color output
- Test emoji display

## Dependencies

- J2 (Enhanced Logging System) completed
- Test environment setup
- OTEL collector running (optional)

## Risks and Mitigation

### Risks

1. **File System Issues**: File logging might fail
2. **OTEL Connectivity**: OTEL collector might not be available
3. **Color Support**: Terminal might not support colors
4. **Environment Variables**: Configuration might not be set correctly

### Mitigation

1. **File System Testing**: Proper file system testing and cleanup
2. **OTEL Mocking**: Mock OTEL collector for testing
3. **Color Detection**: Test color support detection
4. **Environment Setup**: Proper environment variable setup
