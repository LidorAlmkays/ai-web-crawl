# Job 18.5: API Layer Integration

## Objective

Integrate the metrics service into the API layer by updating the REST router to include metrics endpoints and ensuring proper query parameter handling for time range overrides.

## Requirements

### Core Functionality

- [x] Update `rest.router.ts` to import and use `WebCrawlMetricsService`
- [x] Add three new endpoints:
  - `GET /metrics` - Returns Prometheus-formatted metrics
  - `GET /metrics/json` - Returns JSON-formatted metrics
  - `GET /metrics/config` - Returns metrics configuration
- [x] **NEW**: Implement robust query parameter parsing for time range overrides
- [x] **NEW**: Support both `hours` and `houres` (misspelled) query parameters
- [x] **NEW**: Default to 24h when no time parameter is provided
- [x] **NEW**: Validate and sanitize time range parameters

### Query Parameter Handling

- [x] Parse `hours` query parameter from request
- [x] Parse `houres` query parameter as fallback (handle misspelling)
- [x] Convert string to integer with proper validation
- [x] Use default time range (24h) when no parameter provided
- [x] Pass correct hours value to metrics service
- [x] Ensure timeRange in response reflects actual hours used

### Error Handling

- [x] Handle invalid query parameters gracefully
- [x] Return appropriate HTTP status codes
- [x] Provide meaningful error messages
- [x] Log errors for debugging

### Content Types

- [x] Set correct `Content-Type` headers
- [x] `text/plain` for Prometheus metrics
- [x] `application/json` for JSON responses

## Test Criteria

### ✅ Query Parameter Parsing

- [x] Test with `?hours=12` - should return 12h time range
- [x] Test with `?houres=2` - should handle misspelling and return 2h time range
- [x] Test with no parameters - should default to 24h time range
- [x] Test with invalid parameters - should handle gracefully

### ✅ Time Range Override

- [x] Verify `timeRange` field in JSON response matches actual hours used
- [x] Verify Prometheus metrics include correct time range labels
- [x] Verify metrics data is filtered by correct time period

### ✅ Endpoint Functionality

- [x] `/metrics` returns Prometheus format with correct content type
- [x] `/metrics/json` returns JSON format with correct content type
- [x] `/metrics/config` returns configuration data
- [x] All endpoints handle errors gracefully

### ✅ Integration

- [x] Metrics service properly injected into router
- [x] Query parameters correctly passed to service layer
- [x] Response format matches expected structure

## Implementation Details

### Files Modified

- `apps/task-manager/src/api/rest/rest.router.ts` - Added metrics endpoints with robust query parameter handling

### Key Changes

1. **Query Parameter Parsing**: Enhanced to handle both `hours` and `houres` parameters
2. **Time Range Validation**: Proper integer conversion and validation
3. **Default Behavior**: Falls back to 24h when no parameter provided
4. **Response Accuracy**: Ensures timeRange field reflects actual hours used

## Status: ✅ COMPLETED

### Test Results

- ✅ Query parameter parsing works correctly
- ✅ Time range override functionality working
- ✅ All endpoints responding with correct data
- ✅ Error handling implemented
- ✅ Content types set correctly

### Verification

- Tested with `?hours=12` - returns 12h time range ✅
- Tested with `?houres=2` - handles misspelling and returns 2h time range ✅
- Tested with no parameters - defaults to 24h time range ✅
- All endpoints working correctly ✅
