# Job 18.6: OTEL Collector Integration Testing

## Objective

Test the complete OTEL Collector integration: verify that the collector can scrape metrics from Task Manager and forward them to Prometheus, ensuring the full observability pipeline works.

## Status: üîÑ IN PROGRESS

## Implementation Tasks

### 1. OTEL Collector Configuration

**File**: `deployment/observability/configs/otel-collector.yaml` (update)

```yaml
receivers:
  prometheus:
    config:
      scrape_configs:
        - job_name: 'task-manager'
          static_configs:
            - targets: ['host.docker.internal:3000']
          metrics_path: '/metrics'
          scrape_interval: 15s
          honor_labels: true

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024

exporters:
  prometheus:
    endpoint: '0.0.0.0:9464'
    namespace: 'task_manager'
    const_labels:
      service: 'task-manager'

service:
  pipelines:
    metrics:
      receivers: [prometheus]
      processors: [batch]
      exporters: [prometheus]
```

### 2. Test Scripts

**File**: `scripts/test-otel-metrics-integration.js`

```javascript
const axios = require('axios');

async function testOtelIntegration() {
  console.log('Testing OTEL Collector Integration...');

  // Test 1: Task Manager metrics endpoint
  try {
    const response = await axios.get('http://localhost:3000/metrics');
    console.log('‚úÖ Task Manager /metrics endpoint accessible');
    console.log('Response status:', response.status);
    console.log('Content-Type:', response.headers['content-type']);

    // Verify Prometheus format
    const content = response.data;
    if (content.includes('# HELP') && content.includes('# TYPE')) {
      console.log('‚úÖ Prometheus format is correct');
    } else {
      console.log('‚ùå Prometheus format is incorrect');
    }
  } catch (error) {
    console.log('‚ùå Task Manager metrics endpoint failed:', error.message);
  }

  // Test 2: OTEL Collector metrics endpoint
  try {
    const otelResponse = await axios.get('http://localhost:9464/metrics');
    console.log('‚úÖ OTEL Collector metrics endpoint accessible');
    console.log('OTEL Response status:', otelResponse.status);

    // Verify Task Manager metrics are present
    const otelContent = otelResponse.data;
    if (otelContent.includes('web_crawl_new_tasks_total')) {
      console.log('‚úÖ Task Manager metrics found in OTEL Collector');
    } else {
      console.log('‚ùå Task Manager metrics not found in OTEL Collector');
    }
  } catch (error) {
    console.log('‚ùå OTEL Collector metrics endpoint failed:', error.message);
  }
}

testOtelIntegration();
```

## Test Criteria

### ‚úÖ Task Manager Metrics Endpoint Tests

#### Basic Accessibility Tests

- [ ] `/metrics` endpoint is accessible at `http://localhost:3000/metrics`
- [ ] Endpoint returns 200 status code
- [ ] Response is in text/plain format
- [ ] No authentication required for scraping

#### Prometheus Format Validation Tests

- [ ] Response contains `# HELP` lines for all three metrics
- [ ] Response contains `# TYPE` lines with `counter` type
- [ ] Response contains metric lines with correct format
- [ ] Time range labels are properly formatted
- [ ] Metric values are numeric and reasonable

#### Query Parameter Tests

- [ ] `?hours=1` returns metrics for 1 hour
- [ ] `?hours=24` returns metrics for 24 hours
- [ ] No parameter uses default 24 hours
- [ ] Invalid parameters are handled gracefully

### ‚úÖ OTEL Collector Configuration Tests

#### Configuration File Tests

- [ ] `otel-collector.yaml` is properly formatted
- [ ] Task Manager target is correctly configured
- [ ] Scrape interval is set to 15s
- [ ] Metrics path is set to `/metrics`
- [ ] Prometheus exporter is configured

#### Collector Startup Tests

- [ ] OTEL Collector starts without errors
- [ ] Collector loads configuration successfully
- [ ] No configuration validation errors
- [ ] Collector begins scraping immediately

#### Target Discovery Tests

- [ ] Collector can reach Task Manager at `host.docker.internal:3000`
- [ ] Collector discovers the metrics endpoint
- [ ] No connection errors in collector logs
- [ ] Scraping begins automatically

### ‚úÖ OTEL Collector Scraping Tests

#### Scraping Functionality Tests

- [ ] Collector successfully scrapes `/metrics` endpoint
- [ ] Scraping occurs every 15 seconds
- [ ] No scraping errors in collector logs
- [ ] Metrics are received and processed

#### Data Processing Tests

- [ ] Collector processes Prometheus format correctly
- [ ] Batch processor works correctly
- [ ] No data loss during processing
- [ ] Processing time is reasonable

#### Export Tests

- [ ] Collector exports metrics to Prometheus format
- [ ] Exported metrics are available at `:9464/metrics`
- [ ] Task Manager metrics are present in exported data
- [ ] Namespace and labels are applied correctly

### ‚úÖ Prometheus Integration Tests

#### Prometheus Scraping Tests

- [ ] Prometheus can scrape OTEL Collector at `:9464`
- [ ] Task Manager metrics appear in Prometheus
- [ ] Metric names are preserved correctly
- [ ] Labels are preserved correctly

#### Metric Validation Tests

- [ ] `web_crawl_new_tasks_total` metric exists
- [ ] `web_crawl_completed_tasks_total` metric exists
- [ ] `web_crawl_error_tasks_total` metric exists
- [ ] All metrics have correct time_range labels

#### Data Flow Tests

- [ ] Task Manager ‚Üí OTEL Collector ‚Üí Prometheus flow works
- [ ] Data is not lost in transit
- [ ] Timestamps are preserved
- [ ] Metric values are accurate

### ‚úÖ End-to-End Integration Tests

#### Full Pipeline Tests

- [ ] Complete flow: Task Manager ‚Üí OTEL ‚Üí Prometheus ‚Üí Grafana
- [ ] Metrics are visible in Grafana dashboards
- [ ] Real-time updates work correctly
- [ ] Historical data is preserved

#### Performance Tests

- [ ] Scraping interval is maintained (15s)
- [ ] No performance degradation over time
- [ ] Memory usage is reasonable
- [ ] CPU usage is reasonable

#### Reliability Tests

- [ ] System recovers from Task Manager restarts
- [ ] System recovers from OTEL Collector restarts
- [ ] No data loss during restarts
- [ ] Metrics continue flowing after recovery

### ‚úÖ Error Handling Tests

#### Network Error Tests

- [ ] OTEL Collector handles Task Manager downtime gracefully
- [ ] Collector logs appropriate error messages
- [ ] Scraping resumes when Task Manager comes back
- [ ] No collector crashes on network errors

#### Configuration Error Tests

- [ ] Invalid configuration is detected
- [ ] Collector fails gracefully with bad config
- [ ] Error messages are clear and helpful
- [ ] Configuration validation works

#### Data Error Tests

- [ ] Malformed metrics are handled gracefully
- [ ] Invalid Prometheus format is logged
- [ ] Collector continues working with partial data
- [ ] No crashes on data errors

### ‚úÖ Monitoring Tests

#### Log Monitoring Tests

- [ ] OTEL Collector logs are accessible
- [ ] Scraping success/failure is logged
- [ ] Error conditions are properly logged
- [ ] Log levels are appropriate

#### Health Check Tests

- [ ] OTEL Collector health endpoint works
- [ ] Health status reflects actual state
- [ ] Health checks detect failures
- [ ] Health endpoint is accessible

### ‚úÖ Load and Stress Tests

#### Concurrent Scraping Tests

- [ ] Multiple scrapers can access metrics endpoint
- [ ] No race conditions in data collection
- [ ] Performance remains stable under load
- [ ] No resource exhaustion

#### High Frequency Tests

- [ ] System handles increased scrape frequency
- [ ] No data loss at higher rates
- [ ] Performance scales appropriately
- [ ] Resource usage is reasonable

## Success Criteria

- Task Manager metrics endpoint is accessible and returns valid Prometheus format
- OTEL Collector successfully scrapes Task Manager metrics
- OTEL Collector exports metrics to Prometheus format
- Prometheus can scrape and store Task Manager metrics
- Complete observability pipeline works end-to-end
- Error handling is robust and graceful
- Performance is acceptable under normal and stress conditions
- All integration tests pass
- No data loss in the pipeline

## Next Job

After OTEL Collector integration testing is complete and all tests pass, proceed to **Job 18.7: Final Integration and Documentation**
